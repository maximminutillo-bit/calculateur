<script>
  // THEME
  function applyTheme(t){
    const root = document.body;
    const toggleBtn = document.getElementById('theme-toggle');
    if(t==='light'){ root.classList.remove('dark'); toggleBtn.textContent='Clair'; }
    else { root.classList.add('dark'); toggleBtn.textContent='Sombre'; }
  }

  // HELPERS
  const fmt = (n) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0);
  const show = (el) => el.style.display = '';
  const hide = (el) => el.style.display = 'none';

  // CORE (port Python -> JS)
  const conversionLayOrbitx = (back_odds, lay_odds, freebet_amount, commission_percent = 3) => {
    const commission = commission_percent / 100;
    const lay_stake = (freebet_amount * (back_odds - 1)) / (lay_odds - commission);
    const liability = lay_stake * (lay_odds - 1);
    const gain_back = (back_odds - 1) * freebet_amount - liability;
    const gain_lay = lay_stake * (1 - commission);
    const net_result = Math.min(gain_back, gain_lay);
    const conversion = (net_result / freebet_amount) * 100;
    return { lay_stake, liability, gain_back, gain_lay, net_result, conversion };
  };

  const updateIndicator = (conv) => {
    const box = document.getElementById('lay-indicator');
    box.textContent = conv >= 80 ? '✅ Conversion excellente (≥ 80%)' : '⚠️ Conversion insuffisante (< 80%)';
    box.className = 'pill ' + (conv >= 80 ? 'ok' : 'warn');
    show(box);
  };

  const layCalc = () => {
    const F   = parseFloat(document.getElementById('lay-freebet').value.replace(',', '.')) || 0;
    const cB  = parseFloat(document.getElementById('lay-back').value.replace(',', '.')) || 0;
    const cL  = parseFloat(document.getElementById('lay-lay').value.replace(',', '.')) || 0;
    const comm= parseFloat(document.getElementById('lay-comm').value.replace(',', '.'));
    if (!(F > 0 && cB > 1 && cL > 1 && comm >= 0 && (cL - (comm/100)) > 0)) return;

    const r = conversionLayOrbitx(cB, cL, F, isNaN(comm) ? 3 : comm);
    document.getElementById('lay-stake').innerHTML    = '<strong>' + fmt(r.lay_stake) + '</strong>';
    document.getElementById('lay-liability').innerHTML= '<strong>' + fmt(r.liability) + '</strong>';
    document.getElementById('lay-gain-back').innerHTML= '<strong>' + fmt(r.gain_back) + '</strong>';
    document.getElementById('lay-gain-lay').innerHTML = '<strong>' + fmt(r.gain_lay) + '</strong>';
    document.getElementById('lay-net').innerHTML      = '<strong>' + fmt(r.net_result) + '</strong>';
    const conv = Math.round(r.conversion * 100) / 100;
    document.getElementById('lay-conv').innerHTML     = '<strong>' + conv.toFixed(2) + '%</strong>';
    updateIndicator(conv);
    show(document.getElementById('lay-result'));

    try { localStorage.setItem('sc-lay', JSON.stringify({F, cB, cL, comm})); } catch {}
  };

  document.addEventListener('DOMContentLoaded', () => {
    // Theme init
    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);
    const toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) toggleBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('theme', next); applyTheme(next);
    });

    // Buttons (type="button" conseillé dans le HTML)
    const calcBtn  = document.getElementById('lay-calcul');
    const resetBtn = document.getElementById('lay-reset');
    const copyStakeBtn = document.getElementById('copy-stake');

    if (calcBtn)  calcBtn.addEventListener('click', layCalc);
    if (resetBtn) resetBtn.addEventListener('click', () => {
      ['lay-freebet','lay-back','lay-lay','lay-comm'].forEach(id => {
        document.getElementById(id).value = (id==='lay-comm') ? '3' : '';
      });
      hide(document.getElementById('lay-result'));
      hide(document.getElementById('lay-indicator'));
      try { localStorage.removeItem('sc-lay'); } catch {}
    });
    if (copyStakeBtn) copyStakeBtn.addEventListener('click', async () => {
      const v = document.getElementById('lay-stake').textContent.replace(/[^0-9,.-]/g,'').replace(',','.');
      try { await navigator.clipboard.writeText(v); } catch {}
    });

    // Restore
    try {
      const s = JSON.parse(localStorage.getItem('sc-lay') || '{}');
      if (s.F)  document.getElementById('lay-freebet').value = s.F;
      if (s.cB) document.getElementById('lay-back').value = s.cB;
      if (s.cL) document.getElementById('lay-lay').value = s.cL;
      document.getElementById('lay-comm').value = (s.comm !== undefined) ? s.comm : '3';
    } catch {}
  });
</script>
